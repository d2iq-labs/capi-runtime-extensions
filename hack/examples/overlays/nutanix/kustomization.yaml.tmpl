# Copyright 2024 D2iQ, Inc. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
# TODO: current kustomize structure is incorrect and need base + overlay structure as to avoid
# following error: recursed merging from path '/go/src/github.com/deepakm-ntnx/capi-runtime-extensions/hack/examples/bases/nutanix/calico/helm-addon': \
# may not add resource with an already registered id: ConfigMap.v1.[noGrp]/$${CLUSTER_NAME}-pc-trusted-ca-bundle.[noNs]
#  - ./cilium/crs
#  - ./cilium/helm-addon
#  - ./calico/crs
  - ./calico/helm-addon
  - https://raw.githubusercontent.com/nutanix-cloud-native/cluster-api-provider-nutanix/jira/krbn-8065/templates/cluster-template-clusterclass.yaml

namePrefix:

labels:
  - includeSelectors: false
    pairs:
      cluster.x-k8s.io/provider: nutanix

patches:
  - target:
      group: cluster.x-k8s.io
      kind: Cluster
    patch: |-
      - op: "add"
        path: "/spec/topology/class"
        value: "nutanix-quick-start"
      - op: "add"
        path: "/spec/topology/variables/0/value/nutanix"
        value:
          controlPlaneEndpoint:
            host: $${CONTROL_PLANE_ENDPOINT_IP}
            port: $${CONTROL_PLANE_ENDPOINT_PORT}
          prismCentralEndpoint:
            additionalTrustBundle: trust-bundle-root-ca
            host: $${NUTANIX_ENDPOINT}
            insecure: $${NUTANIX_INSECURE}
            port: 9440
          failureDomains:
            - name: fd1
              cluster:
                name: PE1
                type: name
              subnets:
                - name: subnet1
                  type: name
              controlPlane: false
      - op: "add"
        path: "/spec/topology/variables/0/value/controlPlane"
        value:
          nutanix:
            machineDetails:
              bootType: legacy
              cluster:
                name: $${NUTANIX_PRISM_ELEMENT_CLUSTER_NAME}
                type: name
              image:
                name: $${NUTANIX_MACHINE_TEMPLATE_IMAGE_NAME}
                type: name
              memorySize: 4Gi
              subnet:
                - name: $${NUTANIX_SUBNET_NAME}
                  type: name
              systemDiskSize: 40Gi
              vcpuSockets: 2
              vcpusPerSocket: 1
              project:
                name: prj1
                type: name
              additionalCategories:
                - key: key1
                  value: value1
                - key: key2
                  value: value2
              gpus:
                - type: name
                  name: gpu1
                - type: name
                  name: gpu2
      - op: "add"
        path: "/spec/topology/variables/1/value"
        value:
          nutanix:
            machineDetails:
              bootType: legacy
              cluster:
                name: $${NUTANIX_PRISM_ELEMENT_CLUSTER_NAME}
                type: name
              image:
                name: $${NUTANIX_MACHINE_TEMPLATE_IMAGE_NAME}
                type: name
              memorySize: 4Gi
              subnet:
                - name: $${NUTANIX_SUBNET_NAME}
                  type: name
              systemDiskSize: 40Gi
              vcpuSockets: 2
              vcpusPerSocket: 1
              project:
                name: prj1
                type: name
              additionalCategories:
                - key: key1
                  value: value1
                - key: key2
                  value: value2
              gpus:
                - type: name
                  name: gpu1
                - type: name
                  name: gpu2
  - target:
      group: cluster.x-k8s.io
      kind: ClusterClass
    patch: |-
      - op: "add"
        path: "/spec/patches"
        value:
          - name: "cluster-config"
            external:
              generateExtension: "nutanixclusterconfigpatch.capi-runtime-extensions"
              discoverVariablesExtension: "nutanixclusterconfigvars.capi-runtime-extensions"
          - name: "worker-config"
            external:
              generateExtension: "nutanixworkerconfigpatch.capi-runtime-extensions"
              discoverVariablesExtension: "nutanixworkerconfigvars.capi-runtime-extensions"
      - op: "remove"
        path: "/spec/variables"